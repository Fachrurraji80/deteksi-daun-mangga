# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fc1PFe3qqNSuoTyhtNx58xtPFjPbQakL
"""

import streamlit as st

import os
import urllib.request

import numpy as np
import cv2
from PIL import Image
from tensorflow.keras.models import load_model

MODEL_URL = "https://github.com/Fachrurraji80/deteksi-daun-mangga/releases/download/v1.0/model.keras"
MODEL_PATH = "model.keras"

if not os.path.exists(MODEL_PATH):
    with st.spinner("Mengunduh model CNN..."):
        urllib.request.urlretrieve(MODEL_URL, MODEL_PATH)


# =========================
# KONFIGURASI
# =========================
IMG_SIZE = 224

CLASS_NAMES = [
    "Anthracnose",
    "Bacterial Canker",
    "Die Back",
    "Cutting Weevil",
    "Powdery Mildew",
    "Healthy"
]

# =========================
# LOAD MODEL
# =========================

def load_cnn_model():
    return load_model(MODEL_PATH)

model = load_cnn_model()


# =========================
# PREPROCESSING (SAMA DENGAN TRAINING)
# =========================
def preprocess_image(image):
    image = cv2.resize(image, (224, 224))
    image = image.astype("float32") / 255.0
    image = np.expand_dims(image, axis=0)  # <-- WAJIB (batch)
    return image

# =========================
# STREAMLIT UI
# =========================
st.set_page_config(
    page_title="Deteksi Penyakit Daun Mangga",
    layout="centered"
)

st.title("ðŸŒ¿ Deteksi Penyakit Daun Mangga")
st.write(
    "Aplikasi ini menggunakan **Convolutional Neural Network (CNN â€“ EfficientNetB0)** "
    "untuk mendeteksi penyakit pada daun mangga."
)

uploaded_file = st.file_uploader(
    "ðŸ“¤ Upload gambar daun mangga",
    type=["jpg", "jpeg", "png"]
)

if uploaded_file is not None:
    image = Image.open(uploaded_file).convert("RGB")
    image_np = np.array(image)

    st.subheader("ðŸ“· Citra Asli")
    st.image(image, use_container_width=True)

    if st.button("ðŸ” Deteksi Penyakit"):
        processed_image = preprocess_image(image_np)
        
        st.write("Input shape:", processed_image.shape)

        prediction = model.predict(processed_image)
        class_index = np.argmax(prediction)
        confidence = np.max(prediction)

        st.subheader("âœ… Hasil Deteksi")
        st.success(f"**Penyakit:** {CLASS_NAMES[class_index]}")
        st.info(f"**Tingkat Kepercayaan:** {confidence * 100:.2f}%")
